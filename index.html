<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>ç‰›é©¬å€’è®¡æ—¶ Â· å¼¹å¹•è”æœºç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
html,body{
    margin:0;
    height:100%;
    background:#1f1f1f;
    font-family:"Microsoft YaHei",sans-serif;
    overflow:hidden;
}
.wrap{
    position:relative;
    z-index:2;
    height:100%;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    color:#e6e6e6;
}
h1{letter-spacing:3px;margin-bottom:4px}
.subtitle{font-size:13px;color:#aaa;margin-bottom:18px}
.time{font-size:40px;font-weight:bold}
.desc{margin-top:8px;font-size:15px;color:#999}

/* æ‹‰ç£¨ */
.mill-area{position:relative;width:320px;height:320px;margin-top:26px}
.mill{
    position:absolute;
    left:50%;top:50%;
    width:190px;height:190px;
    margin:-95px;
    border-radius:50%;
    border:6px dashed #555;
}
.animal{
    position:absolute;
    left:50%;top:50%;
    width:58px;height:58px;
    margin:-29px;
    animation:walk 10s linear infinite;
    filter:grayscale(1);
}
@keyframes walk{
    from{transform:rotate(0deg) translateX(150px)}
    to{transform:rotate(360deg) translateX(150px)}
}

/* å¼¹å¹•ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šæ”¾å¤§å­—ä½“ã€å›ºå®šè¡Œé«˜ã€ä¸é‡å å¸ƒå±€ */
.bubble{
    position:absolute;
    white-space:nowrap;
    color:#e6e6e6; /* è°ƒäº®å­—ä½“æ›´é†’ç›® */
    font-size:18px; /* æ”¾å¤§å¼¹å¹•å­—ä½“ï¼ˆåŸ14pxï¼‰ */
    font-weight:500;
    z-index:5;
    line-height:36px; /* è¡Œé«˜ï¼Œæ§åˆ¶å‚ç›´é—´è· */
    height:36px; /* å›ºå®šé«˜åº¦ï¼Œé¿å…é‡å  */
}
/* å¼¹å¹•æ— é™æ»šåŠ¨åŠ¨ç”»ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šä»å³åˆ°å·¦å®Œæ•´æ»šåŠ¨ï¼Œæ— é—´æ–­ */
@keyframes danmuMove{
    0%{transform:translateX(100vw);} /* åˆå§‹åœ¨å±å¹•å³ä¾§å¤– */
    100%{transform:translateX(-100%);} /* ç»“æŸåœ¨è‡ªèº«å·¦ä¾§å¤–ï¼ˆå®Œæ•´æ»šå‡ºï¼‰ */
}

/* è¾“å…¥æ¡† */
.input-box{
    position:fixed;
    bottom:18px;
    left:50%;
    transform:translateX(-50%);
    z-index:99;
}
.input-box input{
    padding:8px;
    width:220px;
    font-size:16px;
}
.input-box button{
    padding:8px 16px;
    cursor:pointer;
}

/* ç°å°˜ */
canvas#dust{
    position:absolute;
    left:0;top:0;
    width:100%;height:100%;
    z-index:1;
}
</style>
</head>

<body>

<div class="wrap">
    <h1>ğŸ‚ ç‰›é©¬å€’è®¡æ—¶</h1>
    <div class="subtitle">åŠªåŠ›ä¸ä¸€å®šæœ‰ç»“æœï¼Œä½†ä¸€å®šå¾ˆç´¯</div>
    <div class="time" id="time">00 å¤© 00:00:00</div>
    <div class="desc" id="desc">ä»Šå¤©ä¹Ÿåœ¨æ­£å¸¸è¿è½¬</div>

    <div class="mill-area">
        <div class="mill"></div>
        <svg class="animal" viewBox="0 0 100 100">
            <g fill="#666">
                <ellipse cx="50" cy="55" rx="26" ry="18"/>
                <circle cx="78" cy="50" r="6"/>
                <rect x="20" y="68" width="6" height="18"/>
                <rect x="36" y="68" width="6" height="18"/>
                <rect x="56" y="68" width="6" height="18"/>
                <rect x="72" y="68" width="6" height="18"/>
            </g>
        </svg>
    </div>
</div>

<div class="input-box">
    <input id="danmuInput" placeholder="å‘ä¸€å¥ç‰›é©¬å®£è¨€â€¦">
    <button onclick="sendDanmu()">å‘å°„</button>
</div>

<canvas id="dust"></canvas>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/******** Firebase é…ç½®ï¼ˆâš ï¸ å¿…é¡»æ¢æˆä½ è‡ªå·±çš„ï¼‰ ********/
const firebaseConfig = {
  apiKey: "AIzaSyBdI1mZKLPuJ6YQk2zkSGRErxJszcLFdl4",
  authDomain: "cow-horse-danmu1.firebaseapp.com",
  databaseURL: "https://cow-horse-danmu1-default-rtdb.firebaseio.com",
  projectId: "cow-horse-danmu1",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const danmuRef = db.ref("danmu");
const ONE_HOUR = 60 * 60 * 1000;
    
/******** ç›®æ ‡æ—¶é—´ ********/
const targetDate = new Date("2026-02-12T18:15:00");

/******** å€’è®¡æ—¶ ********/
function update(){
    const now = new Date();
    let diff = targetDate - now;

    if(diff <= 0){
        document.getElementById('time').innerText = "å·²å®Œæˆå½“å‰ä»»åŠ¡";
        document.getElementById('desc').innerText = "æ˜å¤©ç»§ç»­";
        return;
    }

    const d = Math.floor(diff/86400000);
    const h = Math.floor(diff/3600000)%24;
    const m = Math.floor(diff/60000)%60;
    const s = Math.floor(diff/1000)%60;

    document.getElementById('time').innerText =
        d + " å¤© " +
        String(h).padStart(2,'0') + ":" +
        String(m).padStart(2,'0') + ":" +
        String(s).padStart(2,'0');
}
setInterval(update,1000);update();

/******** å¼¹å¹•æ ¸å¿ƒé…ç½®ã€æ–°å¢ã€‘ï¼šæ§åˆ¶ä¸é‡å ã€æ»šåŠ¨é€Ÿåº¦ ********/
const danmuConfig = {
    lineHeight: 36, // ä¸CSSä¸­bubbleçš„line-heightä¸€è‡´ï¼Œæ§åˆ¶å‚ç›´è¡Œé«˜
    speed: 15, // å¼¹å¹•æ»šåŠ¨é€Ÿåº¦ï¼ˆå€¼è¶Šå¤§è¶Šå¿«ï¼ŒåŸ20ç§’â†’ç°åœ¨15ç§’ï¼‰
    maxLines: Math.floor(window.innerHeight / 36), // è‡ªåŠ¨è®¡ç®—æœ€å¤§å¯æ˜¾ç¤ºè¡Œæ•°ï¼ˆé€‚é…å±å¹•ï¼‰
    usedLines: new Set() // è®°å½•å·²å ç”¨çš„è¡Œï¼Œé¿å…é‡å 
};
// çª—å£å¤§å°å˜åŒ–æ—¶é‡æ–°è®¡ç®—æœ€å¤§è¡Œæ•°ã€æ–°å¢ã€‘
window.addEventListener('resize', () => {
    danmuConfig.maxLines = Math.floor(window.innerHeight / danmuConfig.lineHeight);
});

/******** å‘é€å¼¹å¹• ********/
function sendDanmu(){
    const input=document.getElementById('danmuInput');
    if(!input.value.trim()) return;
    danmuRef.push({
        text: input.value,
        time: Date.now()
    });
    input.value="";
}

/******** æ¥æ”¶å¼¹å¹• ********/
const now = Date.now();
danmuRef.once("value", snapshot => {
    snapshot.forEach(child => {
        const data = child.val();
        if (now - data.time <= ONE_HOUR) {
            spawnDanmu(data.text);
        }
    });
});
danmuRef.on("child_added", snap => {
    const data = snap.val();
    if (Date.now() - data.time <= ONE_HOUR) {
        spawnDanmu(data.text);
    }
});

/******** å¼¹å¹•ç”Ÿæˆã€æ ¸å¿ƒé‡å†™ã€‘ï¼šä¸é‡å +æ— é™æ»šåŠ¨+è‡ªåŠ¨é‡Šæ”¾è¡Œ ********/
function spawnDanmu(text){
    const t=document.createElement('div');
    t.className='bubble';
    t.innerText=text;
    document.body.appendChild(t);

    // 1. è‡ªåŠ¨åˆ†é…ä¸é‡å çš„è¡Œã€æ ¸å¿ƒã€‘
    let line = 0;
    for(let i=0; i<danmuConfig.maxLines; i++){
        if(!danmuConfig.usedLines.has(i)){
            line = i;
            danmuConfig.usedLines.add(i);
            break;
        }
    }
    // è‹¥æ— ç©ºé—²è¡Œï¼Œéšæœºè¦†ç›–æœ€é¡¶éƒ¨è¡Œï¼ˆé¿å…å¼¹å¹•æ— æ³•æ˜¾ç¤ºï¼‰
    if(line === 0 && danmuConfig.usedLines.size >= danmuConfig.maxLines){
        line = Math.floor(Math.random() * danmuConfig.maxLines);
    }
    // è®¾ç½®å¼¹å¹•å‚ç›´ä½ç½®ï¼ˆåŸºäºåˆ†é…çš„è¡Œï¼‰
    t.style.top = `${line * danmuConfig.lineHeight}px`;
    t.dataset.line = line; // æŠŠè¡Œå·å­˜åˆ°å…ƒç´ ä¸Šï¼Œæ–¹ä¾¿åç»­é‡Šæ”¾

    // 2. è®¾ç½®æ— é™æ»šåŠ¨åŠ¨ç”»ï¼ˆæ— é—´æ–­ã€é€Ÿåº¦å¯æ§ï¼‰
    const animateTime = `${danmuConfig.speed}s`;
    t.style.animation = `danmuMove ${animateTime} linear infinite`; // infinite=æ— é™å¾ªç¯

    // 3. åŠ¨ç”»ç»“æŸæ—¶é‡Šæ”¾å ç”¨çš„è¡Œã€æ ¸å¿ƒã€‘ï¼šé¿å…è¡Œè¢«æ°¸ä¹…å ç”¨
    t.addEventListener('animationiteration', () => {
        // æ¯æ¬¡å¾ªç¯ç»“æŸåï¼Œé‡æ–°æ£€æŸ¥è¡Œå ç”¨ï¼ˆå…¼å®¹æç«¯æƒ…å†µï¼‰
        if(danmuConfig.usedLines.has(Number(t.dataset.line))){
            // å»¶è¿Ÿé‡Šæ”¾ï¼Œé¿å…åŒè¡ŒåŠ¨ç”»è¡”æ¥é—´éš™é‡å 
            setTimeout(() => {
                danmuConfig.usedLines.delete(Number(t.dataset.line));
            }, 500);
        }
    });

    // 4. å…ƒç´ é”€æ¯æ—¶é‡Šæ”¾è¡Œã€å…œåº•ã€‘
    t.addEventListener('remove', () => {
        danmuConfig.usedLines.delete(Number(t.dataset.line));
    });
}

/******** ç°å°˜ ********/
const c=document.getElementById('dust');
const ctx=c.getContext('2d');
c.width=innerWidth;c.height=innerHeight;
let dusts=[];
for(let i=0;i<120;i++){
    dusts.push({x:Math.random()*c.width,y:Math.random()*c.height,r:Math.random()*2+0.5,v:Math.random()*0.3});
}
function animate(){
    ctx.clearRect(0,0,c.width,c.height);
    ctx.fillStyle='rgba(180,180,180,0.25)';
    dusts.forEach(p=>{
        p.x+=p.v;if(p.x>c.width)p.x=0;
        ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
    });
    requestAnimationFrame(animate);
}
animate();
// ç°å°˜ç”»å¸ƒé€‚é…çª—å£å¤§å°ã€æ–°å¢ã€‘
window.addEventListener('resize', () => {
    c.width = window.innerWidth;
    c.height = window.innerHeight;
});
</script>

</body>
</html>
